name: Tests

on:
  push:
  workflow_dispatch:
jobs:
  indexer:

      runs-on: ubuntu-latest
      steps:
          - uses: actions/checkout@v3
          - uses: actions/setup-python@v4
            with:
              python-version: '3.10' 
          
          
          - id: 'auth'
            name: 'Authenticate to Google Cloud'
            uses: 'google-github-actions/auth@v1'
            with:
              credentials_json: '${{ secrets.GCP_CREDENTIALS }}'
              export_environment_variables: true
          
          - name: 'Set up Cloud SDK'
            uses: 'google-github-actions/setup-gcloud@v1'
          
          - name: "install cli dependencies"
            run: 
              pip install poetry && cd packages/cli && POETRY_VIRTUALENVS_CREATE=false poetry install && cd ../..
            

          - name: 'Indexer Tests'
            run: python3 packages/cli/cli/main.py test indexer

          - name: "Coverage Comment"
            uses: MishaKav/pytest-coverage-comment@main
            with:
              pytest-coverage-path: ./packages/indexer/reports/pytest-coverage.txt
              junitxml-path: ./packages/indexer/reports/pytest.xml
              title: "Indexer Coverage Report"
              coverage-path-prefix: "packages/indexer"
          
          - run: echo ${{ steps.coverageComment.outputs.failures }}
          - run: echo ${{ steps.coverageComment.outputs.coverage }}

          - name: "Fail?"
            if: ${{ steps.coverageComment.outputs.failures }} == ${{ 0 }} && ${{ steps.coverageComment.outputs.coverage }} < ${{ 85 }}
            uses: actions/github-script@v3
            with:
              script: |
                  core.setFailed('Coverage not correct!')

          
  parse:
      runs-on: ubuntu-latest
      steps:
          - uses: actions/checkout@v3

          - uses: actions/setup-python@v4
            with:
              python-version: '3.10'  
          
          - name: "install cli dependencies"
            run: 
              pip install poetry && cd packages/cli && POETRY_VIRTUALENVS_CREATE=false poetry install && cd ../..
            
          
          - name: 'Parse Tests'
            run: python3 packages/cli/cli/main.py test parse

          - name: "Coverage Comment"
            uses: MishaKav/pytest-coverage-comment@main
            with:
              pytest-coverage-path: ./packages/parse/reports/pytest-coverage.txt
              junitxml-path: ./packages/parse/reports/pytest.xml
              title: "Parse Coverage Report"
              coverage-path-prefix: "packages/parse"
          
          - run: echo ${{ steps.coverageComment.outputs.failures }}
          - run: echo ${{ steps.coverageComment.outputs.coverage }}

          - name: "Fail?"
            if: ${{ steps.coverageComment.outputs.failures }} == ${{ 0 }} && ${{ steps.coverageComment.outputs.coverage }} < ${{ 90 }}
            uses: actions/github-script@v3
            with:
              script: |
                  core.setFailed('Coverage not correct!')